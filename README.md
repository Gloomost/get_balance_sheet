# 提取年报中的（合并）资产负债表
### 在利用大模型对上市公司短期偿债能力进行分析时，第一步就是在公司年报中读取相应指标（货币资金、流动负债合计等），完成现金比率、流动比率、速动比率的计算。但在实际完成过程中，对这些数据的提取会出现多种问题：
### 1.流动负债合计与其他指标放在一起查询时会导致所有指标均查询出错
### 2.很多公司的年报中有合并资产负债表和母公司资产负债表两张表，且这两张表属于跨页表格，大模型很难分清这两张表，查询时会将两张表中的数据混淆
### 3.资产负债表中的两列并不全是今年在前，去年在后，同时在大部分表头都是xx年12月31日时，也有部分表会出现xx年1月1日的表头，这导致大模型很难分清要查询的年份
### 为了解决以上问题，在尝试多种方案后，通过使用python中的pdfplumber库对pdf中的表格进行提取并对表格进行处理，最终完成了大部分年报中资产负债表的提取，截至目前，本项目已测试54个年报，均可正确完整地提取出资产负债表。
## 使用方法如下：
### 项目中有两个函数可供选择，分别是batch函数和one函数。batch函数中输入变量为start和last，目的是可以批量提取表格，两者是通过遍历出的文件list的下标，通过修改这两个变量可以控制要提取资产负债表的数量及范围；one函数中可以单独输入文件路径，提取单个文件的表格，方便对单个年报进行资产负债表的提取，注意，输入路径中，文件名称前的分隔符为反斜杠\\
## 注意：
### 该项目只对年报中资产负债表的提取有效，尚未实现对年报中其他表格或者其他pdf表格中跨页表格的一般化提取
## 实现过程：
### step1 通过pdfplumber库抽取年报pdf中所有表格的文本，保存为嵌套列表格式
#### question1 可以通过判断上一页结尾和下一页开头是否为表格来对跨页表格进行合并，为什么不直接判断？
#### answer1 由于年报中存在页眉和页码，且每个公司的年报格式不统一，没办法通过对pdf进行截取或其他方式实现跨页表格的合并
### step2 定位资产负债表：对每个表的表头进行处理（删除None和""等处理），对列表表头所在的list进行判断，如果list[0]（即表头的第一个单元格）的值为"项目"，list[-1]和list[-2]（表头的倒数第一个单元格和倒数第二个单元格）对"20""年""月""日"的模糊匹配为true，那么将资产负债表的第一个表定位到这里。
#### question2 为什么是倒数第一个和倒数第二个单元格而不是第二个和第三个单元格？
#### answer2 因为资产负债表第二列有可能是"附注"，为了保证不被"附注"影响，只考虑倒数第一列和倒数第二列
#### question3 为什么通过这种方法定位不会定位到母公司资产负债表？
#### answer3 因为母公司资产负债表在合并资产负债表下面，所以先定位到合并资产负债表，通过后面的表格末尾识别完成资产负债表的提取。
### step3 将从step2中定位到的表格作为资产负债表的第一张表，由于资产负债表是跨页表格，认为一直到截止符前的表格均为资产负债表。截止符定义为"负债和所有者权益"，这是每个资产负债表最后一行都会有的项目，名称大同小异，因此使用该截止符做模糊匹配，从而确定资产负债表的最后一张表。
### step4 将每一行识别为嵌套list后，需要将每一行填入对应的"项目""年份1""年份2"中，通过对表格中的每个项目名称观察发现，项目名称前后有相同的空格，因此将以项目名称为中心字符串的几个字符串合并作为项目名称，填入"项目"中。对list中后面的元素进行识别，如果存在两个不为空的字符串，那么依次填入表格中；如果不存在不为空的字符串，那么两个年份下该项目的值为0；如果后面只有一个字符串不为空，那么判断该字符串在“删除项目名称后的新list”中的位置，如果在length/2之前，那么填入"年份1"的下面，反之，填入"年份2"的下面。
#### question4 为什么是"年份1""年份2"而不是"今年""去年"？
#### answer4 因为格式不统一，有的公司习惯将"去年"填在"今年"之前，因此在该阶段只用关注"年份1""年份2"，如何处理年份混乱及"1月1日"等问题留到后面解决。
### step5 对存在"附注"列的表格需要做单独处理，通过对有"附注"列的表格提取成list进行观察后发现，此类表格格式规整，"附注"列在list中往往只表示为一个空字符串，因此在提取项目名称后，将“删除项目名称后的新list”中的第一个元素删除即可。
### step6 重新编辑表格，统一格式：将上面提取后的表格转换成Dataframe格式进行拼接，先搜索表头，如果表头中存在"1月1日"，那么对该单元格中的日期进行修改，修改为上一年的"12月31日"。然后比较两个单元格的日期大小，将今年所在的列放在左边，去年所在的列放在右边。
### step7 将修改后的Dataframe保存为pdf格式。
